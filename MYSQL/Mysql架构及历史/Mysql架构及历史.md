## Mysql逻辑架构

> ![image-20211209162144950](image-20211209162144950.png) 
>
> - **连接管理与安全性**
>
> - **优化与执行**
>
> - **并发控制**
>
>   - 读写锁
>
>     > 共享锁(shared lock) 读锁
>     >
>     > 排他锁(exclusive lock) 写锁
>
>   - 锁粒度(基于MYSQL引擎选择)
>
>     > 行锁(row lock) => InnoDB  XtraDB 
>     >
>     > > 最大程度支持并发
>     >
>     > 表锁(table lock)
>
> - **事务** 
>
>   > - 原子(atomicity)  
>   > - 一致(consistency) 
>   > - 隔离(isolation) 
>   > - 持久性(durability)
>   >
>   > 
>   >
>   > **隔离级别**
>   >
>   > - READ UNCOMMITTED
>   > - READ COMMITED 
>   > - REPEATABLE READ 可重复读 (在事务中语句查询的数据**内容一致**，幻读：一个事务在执行中读取到另一个事务**插入**已提交的数据，读取2次数据返回不一样）
>   > - SERIALIZABLE （避免幻读情况，**可以接受无并发场景**）
>   >
>   > ![image-20211209170510875](image-20211209170510875.png) 
>   >
>   > -  死锁
>   >
>   >   > 多个事务加锁在同一个资源上,并**相互请求锁定**对方占用的资源
>   >   >
>   >   > InnoDB处理死锁将持有少数行级排他锁进行事务回滚
>   >   
>   > - 事务日志
>   >
>   >   > 先将操作的记录写在硬盘事务日志中(顺序I/O),在将内存中的数据进行更新在持久化到硬盘上
>   >
>   > -  MYSQL中事务(InnoDB ，NDBCluster，XtraDB,PDXT)
>   >
>   >    > ~~~sql
>   >    >  -- 1表示开启  0 表示关闭
>   >    > show variables like 'AUTOCOMMIT'
>   >    > set autocommit = 1
>   >    > -- 配置当前会话隔离级别
>   >    > set session transaction isolation level read commited
>   >    > ~~~
>   >
>   > -  LOCK/UNLOCK TABLES  在服务层进行加锁 与存储引擎无关
>
> - **多版本并发控制(MVCC)** 基于行锁控制
>
> > MVCC通过数据时间点快照实现（根据事务开始时间，每个事务对同一张表，**同一时刻看到的数据可能不一样**）
> >
> > InnoDB 的MVCC实现过程
> >
> > - 每行记录存在两个隐藏列，包含行的创建时间(系统版本号)，和删除时间(系统版本号)
> > - 每开始一个新事务,系统版本号自动递增
> >
> > InnoDB  repeatable read 隔离级别下 
> >
> > 查找时
> >
> > - InnoDB只查找版本**早于当前事务版本**的数据行（确保事务开始前存在，事务自身插入的行）
> > - 行的删除版本未定义，或大于当前事务的版本号（确保事务读取到的行在**事务开始之前未被删除**） 
> >
> > 插入时
> >
> > - InnoDB为新插入的每一行保存当前系统版本号作为行号
> >
> > 删除时
> >
> > - InnoDB为删除的行每行保存当前系统版本号作为删除标识
> >
> > 修改时
> >
> > - 将当前行号保存到删除标识，在将当前系统号保存到行号
> >
> > MVCC只在REPEATABLE READ和READ COMMITTED 两个级别下兼容
>
> **MYSQL存储引擎**
>
> > Mysql将每个数据库保存作为目录，将数据库下的表.frm文件放在数据库目录下
> >
> > 查看表状态
> >
> > ~~~sql
> > show table status like 'tablename';
> > ~~~
> >
> > - Row_format 行格式   
> >
> >   > Dynamic 行长度可变（包含varchar blob类型字段）
> >   >
> >   > fixed（行长度固定）
> >   >
> >   > Compressed（压缩表）
> >
> > **InnoDB存储引擎**(处理大量短期事务)
> >
> > 
> >
> > **MyISAM存储引擎（全文索引，压缩，空间函数）**不支持事务和行级锁
> >
> > - 表存储  .MYD 和.MYI 分别存储数据文件和索引文件
> >
> > - 加锁并发
> >
> > - 修复（检查表错误）
> >
> > - 索引特性
> >
> >   > 延迟更新索引键
> >   >
> >   > 超长索引
> >
> > - MyISAM 压缩表
> >
> >   > 不修改的数据进行压缩处理
> >
> > **Archive引擎（适合日志采集）**
> >
> > > 只支持INSERT和SELECT操作
> >
> > **Blackhole引擎**
> >
> > **CSV引擎(处理CSV文件)**
