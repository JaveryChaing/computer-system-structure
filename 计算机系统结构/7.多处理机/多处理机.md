## 多处理机

- **分布式存储器多处理机**(存储器与处理单元分开)

  > <img src="img\image-20220905114213493.png" alt="image-20220905114213493" style="zoom:67%;" /> 
  >
  > - 降低存储器和互联网络的带宽需求
  > - 对本地存储器的访问延迟小
  > - 处理器之间通信复杂，处理器之间访问延迟大
  >
  > ---
  >
  > **存储器存储方式**
  >
  > - 共享全局地址空间（具有统一逻辑地址）
  >
  > - 分布式独立地址空间（不同结点地址独立，处理单元只能对本存储空间进行访问）
  >
  > - NUMA机器(分布式独立地址)
  >
  >   > <img src="img\image-20220905141526319.png" alt="image-20220905141526319" style="zoom:50%;" /> 
  >
  > **存储器通信机制**
  >
  > - 共享存储器通信(共享地址)
  >
  >   > *处理器之间通过load和store指令对相同存储器进行读写操作*
  >
  > - 消息传递通信
  >
  >   > 处理器显式传递消息（处理器之间发送接收数据停下通信，不经过存储器）
  >   >
  >   > RPC远程进程调用
  >
  > <img src="img\image-20220905142216835.png" alt="image-20220905142216835" style="zoom:50%;" /> 
  >
  > 
  >
  > **共享存储器通信优点**
  >
  > - 常用对称式处理器
  > - 易于编程，简化编译器设计
  > - 通过基于**内存模型开发应用程序**
  > - 通信数据量小，带宽利用高
  > - 可以采用Cache计数减少通信延迟和数据共享访问冲突
  >
  > ---
  >
  > **消息传递通信机制优点**
  >
  > - 硬件实现简单
  >
  > - 显示通信，注重通信开销，易于开发性能高的并行程序
  >
  > - 基于同步通信方式，减少并发带来的错误
  >
  >   
  >
  > *在共享存储器上支持消息传递简单，消息传递机器上支持共享存储器比较困难*

#### **多处理机Cache一致性**

> *对称式共享存储器多个处理器共享一个存储器*
>
> <img src="img\image-20220905143549718.png" alt="image-20220905143549718" style="zoom:60%;" /> 
>
> **存储系统行为分析：**
>
> - what ： 读操作得到是什么值
> - when ： 什么时候将值返回给读操作
>
> **Cache一致性协议**（跟踪共享数据块的状态）
>
> - **监听式协议（MSI)**
>
>   > CPU进行读操作时，先把请求放入总线上广播，判断其他Cache上是否含有目标数据，目标数据包含Cache共享状态信息 ，在进行相应操作。
>   >
>   > **处理器写更新操作**
>   >
>   > - 写作废（对数据写操作时，保证处理器对该数据有唯一的访问权，作废其他Cache中副本）
>   > - 写更新（通过总线广播所有Cache对该项数据副本进行更新）
>   >
>   > *在对一项数据多次写而无读情况下，写更新操作性能开销大，在存在多核写读情况下，写更新存在延迟较少*
>   >
>   > ---
>   >
>   > **存储器写策略**
>   >
>   > - 写直达（同时更新所有Cache和内存中值，性能低）
>   > - 写回（仅把数据写回Cache中，存在cache与主存数据不一致）
>   >
>   >  
>   >
>   > **采用写直达作废的Snoop：**（**写入内存和Cache，同时在通知总线作废其他Cache**）
>   >
>   > 
>   >
>   > **采用写回作废的Snoopy：**
>   >
>   > > <img src="img\image-20220905154404574.png" alt="image-20220905154404574" style="zoom:50%;" /> 
>   > >
>   > > **Cache块中有三种状态**
>   > >
>   > > - 无效I
>   > > - 共享S（**内存与Cache值一致**）
>   > > - 已修改M (Cache已修改，未写回存储器)
>   > >
>   > > **总线事件**
>   > >
>   > > - RdMiss ：读不命中 
>   > > - WtMiss：写不命中
>   > > - Invalidate：通知其他处理器作废其Cache中相应副本（不从内存中调块）
>   > >
>   > > Snoopy中Cache状态变化
>   > >
>   > > 1. 读缺失（从内存中装入Cache,并修改状态为S，其他处理器读入Cache，不会此Cache状态)
>   > > 2. 其他处理器写（此Cache状态变为I）
>   > > 3. 此处理器写（将Cache状态变为M，**此处理器读，写操作不会更改此Cache状态**，**其他处理器写该Cache，需要将此Cache状态变为I，将其他Cache中状态变为I，并写回存储器，其他处理器进行读，需要将此Cache状态变为S，并写回内存**）
>
> - **目录式协议（directory)**
>
>   > <img src="img\image-20220905145416951.png" alt="image-20220905145416951" style="zoom:50%;" />  
>

#### **多处理机同步机制**

> **硬件原语**（一组已原子操作的方式读出并修改存储单元的指令）
>
> - **原子交换**（将存储单元的值与寄存器的值进行交换）
>
> - **测试并置定**（测试存储单元的值，符合条件则修改其值)
>
> - **读取并加1**（返回存储单元的值并自动增加该值）
>
> - **LI与SC** （特殊取指令与特殊存指令，实际就是自旋判断修改）
>
>   



  

  

  

  

  